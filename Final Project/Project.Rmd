---
title: "Final Project"
author: "Omar Aldawy Ibrahim Aldawy - Bahaa Khalid Mohamed Ali"
date: "2025-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
# Install required packages if not already installed
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install(c("SNPRelate", "GENESIS", "qqman", "GeneNet", "xlsx", "GWASTools", "SeqVarTools", "SeqArray"))

if(!require("SNPRelate", quietly = TRUE))
    install.packages("SNPRelate")

if(!require("GENESIS", quietly = TRUE))
    install.packages("GENESIS")

if(!require("dplyr", quietly = TRUE))
    install.packages("dplyr")

if(!require("openxlsx", quietly = TRUE))
    install.packages("openxlsx")
```

# Task 1 : Compute Kinship using SNPRelate and GENESIS

```{r}
# Load required libraries
library(SNPRelate)
library(GENESIS)
library(GWASTools)
library(SeqVarTools)
library(SeqArray)
library(dplyr)
library(openxlsx)
```

```{r}
# Convert PLINK format to GDS format
snpgdsPED2GDS("Dataset/input.ped", "Dataset/input.map", "Dataset/genotype.gds")

# Open the GDS file
genofile <- snpgdsOpen("Dataset/genotype.gds")

# Calculate kinship using MLE method
ibd <- snpgdsIBDMLE(genofile, 
                        num.thread = 6,  
                        autosome.only = FALSE,
                        kinship = TRUE)  

kinship <- ibd$kinship
rownames(kinship) <- colnames(kinship) <- ibd$sample.id

# Close the GDS file
snpgdsClose(genofile)

# Count individuals with kinship > 0.1
high_kinship <- (sum(kinship > 0.1, na.rm = TRUE) - 156) / 2.0  
cat("Number of individuals with kinship > 0.1:", high_kinship, "\n")
```

# Task 2: Compute mQTLs with Mixed Models
```{r}
# Load PCA data
pca_data <- read.table("Dataset/Dataset of 156 Qataris/pca_results.eigenvec", header = FALSE)
colnames(pca_data) <- c("FID", "IID", paste0("PC", 1:20))
rownames(pca_data) <- pca_data$IID
pcs <- pca_data[, c("PC1", "PC2", "PC3")]

# Load metabolite data
metabolites <- read.csv("Dataset/qatari_metabolites_2025.csv", row.names = 1)

# Merge PCA with metabolite data
all.data <- as.data.frame(cbind(pcs, metabolites))
meta.names <- colnames(metabolites)

# Sample IDs
scan_annot_df <- data.frame(
  scanID = rownames(metabolites),
  stringsAsFactors = FALSE
)
rownames(scan_annot_df) <- scan_annot_df$scanID
scan_annot <- ScanAnnotationDataFrame(scan_annot_df)
```

```{r}
genoFile <- "Dataset/genotype.gds"
gds <- GdsGenotypeReader(genoFile)
genoData <- GenotypeData(gds, scanAnnot = scan_annot)
```

```{r}
results <- list()

for (meta in meta.names) {
  df <- all.data[, c("PC1", "PC2", "PC3", meta)]
  colnames(df)[4] <- "trait"
  
  null.model <- fitNullModel(
    x = df,
    outcome = "trait",
    covars = c("PC1", "PC2", "PC3"),
    cov.mat = kinship,
    family = "gaussian",
    verbose = TRUE
  )
  
  genoIterator <- GenotypeBlockIterator(genoData)
  assoc <- assocTestSingle(
    gdsobj = genoIterator,
    null.model = null.model,
    test = "Score",
    verbose = TRUE
  )
  
  assoc$metabolite <- meta
  results[[meta]] <- assoc
}

head(results$Metabolite5)

dim(results$Metabolite5)
```

```{r}
close(gds)
```

```{r}
all_results <- bind_rows(results)  
significant_results <- filter(all_results, Score.pval < 0.0001)
dim(significant_results)

write.xlsx(signif_results, file = "Dataset/Significant_results.xlsx", rowNames = FALSE)
write.xlsx(all_results, file = "Dataset/All_results.xlsx", rowNames = FALSE)
```

# Task 4: Create Manhattan Plots

```{r}

library(readxl)
library(ggplot2)

# 1. Load data
input_file <- "Dataset/All_results.xlsx"
df <- read_excel(input_file, sheet = 1)

# 2. Rename & clean columns
df$SNP        <- df$variant.id
df$CHR        <- as.numeric(df$chr)
df$BP         <- as.numeric(df$pos)
df$P          <- as.numeric(df$Score.pval)
df$Metabolite <- as.factor(df$metabolite)

# 3. Output directory
out_dir <- "plots"
if (!dir.exists(out_dir)) dir.create(out_dir)

# 4. Thresholds
threshold_gw   <- 1e-4
threshold_sugg <- 1e-5

# 5. Per-metabolite ggplot2 Manhattan plots
mets <- levels(df$Metabolite)

for (met in mets) {
  subdf <- subset(df, Metabolite == met)
  subdf <- subdf[complete.cases(subdf[, c("CHR","BP","P")]), ]
  subdf <- subset(subdf, CHR %in% 1:22 & P > 0 & P <= 1)
  
  if (nrow(subdf) < 10) {
    warning(sprintf("Skipping %s: only %d valid SNPs", met, nrow(subdf)))
    next
  }
  
  # Add -log10(P)
  subdf$negLogP <- -log10(subdf$P)
  
  # Plot using ggplot2
  p <- ggplot(subdf, aes(x = BP, y = negLogP, color = factor(CHR))) +
    geom_point(alpha = 0.6, size = 0.7) +
    geom_hline(yintercept = -log10(threshold_gw), linetype = "dashed") +
    geom_hline(yintercept = -log10(threshold_sugg), linetype = "dotted") +
    labs(
      title = paste("Manhattan Plot â€”", met),
      x = "Genomic Position (bp)",
      y = expression(-log[10](P)),
      color = "Chromosome"
    ) +
    theme_bw(base_size = 12) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    )
  
  # Save the plot
  ggsave(
    filename = file.path(out_dir, paste0("Manhattan_", met, ".png")),
    plot     = p,
    width    = 12,
    height   = 6,
    dpi      = 300
  )
}

\library(dplyr)

# Keep the best P-value per SNP
df_unique <- df %>%
  filter(!is.na(P), CHR %in% 1:22, P > 0 & P <= 1) %>%
  group_by(SNP, CHR, BP) %>%
  summarize(P = min(P), .groups = "drop") %>%
  mutate(negLogP = -log10(P))

# Plot
p_all <- ggplot(df_unique, aes(x = BP, y = negLogP, color = factor(CHR))) +
  geom_point(alpha = 0.6, size = 0.7) +
  geom_hline(yintercept = -log10(threshold_gw), linetype = "dashed") +
  geom_hline(yintercept = -log10(threshold_sugg), linetype = "dotted") +
  labs(
    title = "Combined Manhattan Plot (All Metabolites)",
    x = "Genomic Position (bp)",
    y = expression(-log[10](P)),
    color = "Chromosome"
  ) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

# Save plot
ggsave(
  filename = file.path(out_dir, "Manhattan_all_combined.png"),
  plot     = p_all,
  width    = 12,
  height   = 6,
  dpi      = 300
)

```



